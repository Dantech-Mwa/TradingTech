<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elite Live Trading</title>
  <style>
    :root[data-theme="dark"] {
      --bg: #0f0f1a; --card: rgba(20,20,40,0.7); --text: #e0e0ff; --green: #00ff88; --red: #ff3b5c;
      --accent: #00d4ff; --grid: rgba(255,255,255,0.1); --border: rgba(255,255,255,0.1);
    }
    :root[data-theme="light"] {
      --bg: #f8f9fa; --card: rgba(255,255,255,0.9); --text: #212529; --green: #28a745; --red: #dc3545;
      --accent: #007bff; --grid: rgba(0,0,0,0.1); --border: rgba(0,0,0,0.1);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; padding:12px; min-height:100vh; }
    .container { max-width:1400px; margin:0 auto; }
    .header { text-align:center; padding:12px; background:var(--card); border-radius:16px; border:1px solid var(--border); }
    h1 { font-size:2rem; font-weight:800; background:linear-gradient(90deg,var(--green),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    #price { font-size:2.5rem; font-weight:900; margin:8px 0; }
    #status { font-size:0.9rem; margin:8px 0; }
    .status.live { color:var(--green); }
    .status.error { color:var(--red); }
    .controls { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin:12px 0; }
    .btn { padding:8px 16px; border:none; border-radius:8px; background:var(--accent); color:#fff; cursor:pointer; font-weight:600; }
    .btn:hover { background:#aa00ff; }
    .btn.active { background:var(--green); }
    .search-container { display:flex; gap:8px; margin:12px 0; }
    #symbolSearch { padding:8px 12px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text); flex:1; max-width:300px; }
    #symbolResults { background:var(--card); border:1px solid var(--border); border-radius:8px; max-height:200px; overflow-y:auto; position:absolute; z-index:100; width:300px; }
    .result-item { padding:8px; cursor:pointer; border-bottom:1px solid var(--border); }
    .result-item:hover { background:var(--accent); color:#fff; }
    canvas { width:100%; height:500px; background:var(--card); border-radius:16px; margin:16px 0; border:1px solid var(--border); }
    .indicators-panel { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    .ind-btn { padding:6px 12px; background:var(--card); border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text); }
    .ind-btn.active { background:var(--accent); color:#fff; }
    .footer { text-align:center; margin:24px 0; font-size:0.8rem; color:#888; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Elite Live Trading</h1>
      <div id="price">$0.00</div>
      <div id="status" class="status">Starting...</div>
      <div class="search-container">
        <input type="text" id="symbolSearch" placeholder="Search 2300+ symbols...">
        <div id="symbolResults"></div>
      </div>
      <div class="controls">
        <button class="btn active" data-symbol="BTCUSDT">BTC</button>
        <button class="btn" data-symbol="ETHUSDT">ETH</button>
        <button class="btn" data-symbol="BNBUSDT">BNB</button>
      </div>
      <div class="indicators-panel" id="indicators">
        <button class="ind-btn" data-ind="none">No Overlay</button>
        <button class="ind-btn" data-ind="sma">SMA</button>
        <button class="ind-btn" data-ind="rsi">RSI</button>
        <button class="ind-btn" data-ind="volume">Volume</button>
      </div>
    </div>
    <canvas id="chart"></canvas>
    <div class="footer">Live Candles • Click Indicators • Our System</div>
  </div>

  <script>
    // ──────────────────────────────────────────────────────────────
    // PURE CANVAS CANDLESTICK + INDICATORS + FIXED WS
    // ──────────────────────────────────────────────────────────────
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    let width, height;
    let candles = [], currentSymbol = 'BTCUSDT', ws = null;
    let reconnectTimeout, activeIndicator = 'none';
    let allSymbols = [];

    // Resize
    function resize() {
      width = canvas.clientWidth; height = canvas.clientHeight;
      canvas.width = width; canvas.height = height;
      draw();
    }
    window.addEventListener('resize', resize);

    // Status & Price
    function setStatus(msg, type = 'info') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = `status ${type}`;
    }
    function updatePrice(p) {
      document.getElementById('price').textContent = `$${parseFloat(p).toFixed(2)}`;
    }

    // Fixed WebSocket for Candles
    function connectWS() {
      if (ws) {
        ws.onopen = ws.onmessage = ws.onerror = ws.onclose = null;
        ws.close();
      }
      clearTimeout(reconnectTimeout);
      setStatus('Connecting...', 'info');
      const stream = currentSymbol.toLowerCase() + '@kline_1m'; // Candles stream
      ws = new WebSocket('wss://stream.binance.com:9443/ws/' + stream);

      ws.onopen = () => {
        setStatus('LIVE • Candles', 'live');
        fetchInitialData();
      };

      ws.onmessage = e => {
        const k = JSON.parse(e.data).k;
        if (k.x) { // Closed candle
          const candle = {
            time: k.t / 1000,
            open: +k.o,
            high: +k.h,
            low: +k.l,
            close: +k.c,
            volume: +k.v
          };
          candles.push(candle);
          if (candles.length > 100) candles.shift();
          updatePrice(k.c);
          draw();
        }
      };

      ws.onerror = () => setStatus('Error - Retrying', 'error');
      ws.onclose = () => {
        setStatus('Reconnecting...', 'error');
        reconnectTimeout = setTimeout(connectWS, 3000);
      };
    }

    // Initial Data Fetch
    async function fetchInitialData() {
      try {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=1m&limit=50`);
        const data = await res.json();
        candles = data.map(k => ({
          time: k[0] / 1000,
          open: +k[1],
          high: +k[2],
          low: +k[3],
          close: +k[4],
          volume: +k[5]
        }));
        updatePrice(candles[candles.length - 1]?.close || 0);
        draw();
        setStatus('LIVE • 50 Candles Loaded', 'live');
      } catch (e) {
        setStatus('Fallback Mode', 'error');
        setTimeout(fetchInitialData, 2000);
      }
    }

    // Pure Canvas: Candles + Indicators
    function draw() {
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card').trim();
      ctx.fillRect(0, 0, width, height);
      if (candles.length < 1) return;

      const minTime = Math.min(...candles.map(c => c.time));
      const maxTime = Math.max(...candles.map(c => c.time));
      const minPrice = Math.min(...candles.map(c => c.low));
      const maxPrice = Math.max(...candles.map(c => c.high));
      const range = maxPrice - minPrice || 1;
      const padding = 50, candleWidth = (width - 2*padding) / candles.length;

      // Grid
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (height - 2*padding) * (i/5);
        ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(width - padding, y); ctx.stroke();
      }

      // Candles
      candles.forEach((c, i) => {
        const x = padding + (width - 2*padding) * ((c.time - minTime) / (maxTime - minTime));
        const top = height - padding - (height - 2*padding) * ((c.high - minPrice) / range);
        const bottom = height - padding - (height - 2*padding) * ((c.low - minPrice) / range);
        const openY = height - padding - (height - 2*padding) * ((c.open - minPrice) / range);
        const closeY = height - padding - (height - 2*padding) * ((c.close - minPrice) / range);

        // Wick
        ctx.strokeStyle = c.close >= c.open ? 'var(--green)' : 'var(--red)';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();

        // Body
        ctx.fillStyle = c.close >= c.open ? 'var(--green)' : 'var(--red)';
        const bodyTop = Math.min(openY, closeY);
        const bodyHeight = Math.abs(openY - closeY);
        ctx.fillRect(x - candleWidth/2, bodyTop, candleWidth, bodyHeight);

        // Volume (simple bars under)
        if (activeIndicator === 'volume') {
          const volY = height - 20;
          const volHeight = (c.volume / Math.max(...candles.map(c => c.volume))) * 50;
          ctx.fillStyle = c.close >= c.open ? 'rgba(0,255,136,0.5)' : 'rgba(255,59,92,0.5)';
          ctx.fillRect(x - candleWidth/2, volY - volHeight, candleWidth, volHeight);
        }
      });

      // Indicator Overlay (e.g., SMA line)
      if (activeIndicator === 'sma') {
        const sma = calculateSMA(candles, 20);
        ctx.strokeStyle = 'var(--gold)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        sma.forEach((val, i) => {
          const x = padding + (width - 2*padding) * (i / (sma.length - 1));
          const y = height - padding - (height - 2*padding) * ((val - minPrice) / range);
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      // RSI (separate scale if needed)
      if (activeIndicator === 'rsi') {
        const rsi = calculateRSI(candles, 14);
        // Draw as line in lower third (simplified)
        const rsiMin = 0, rsiMax = 100;
        ctx.strokeStyle = 'var(--purple)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        rsi.forEach((val, i) => {
          const x = padding + (width - 2*padding) * (i / (rsi.length - 1));
          const y = height * 0.7 + (height * 0.3) * ((rsiMax - val) / rsiMax); // Lower panel
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      // Labels
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
      ctx.font = '14px Inter';
      ctx.fillText(`High: $${maxPrice.toFixed(2)}`, 10, 20);
      ctx.fillText(`Low: $${minPrice.toFixed(2)}`, 10, height - 10);
    }

    // Simple Indicators
    function calculateSMA(data, len) {
      if (data.length < len) return [];
      return data.slice(len - 1).map((c, i) => {
        const sum = data.slice(i, i + len).reduce((s, d) => s + d.close, 0) / len;
        return sum;
      });
    }

    function calculateRSI(data, len) {
      if (data.length < len + 1) return [];
      let gains = 0, losses = 0;
      for (let i = 1; i <= len; i++) {
        const change = data[i].close - data[i-1].close;
        if (change > 0) gains += change; else losses -= change;
      }
      let avgGain = gains / len, avgLoss = losses / len;
      const rsi = [100 - (100 / (1 + avgGain / (avgLoss || 1)))];
      for (let i = len + 1; i < data.length; i++) {
        const change = data[i].close - data[i-1].close;
        avgGain = (avgGain * (len - 1) + (change > 0 ? change : 0)) / len;
        avgLoss = (avgLoss * (len - 1) + (change < 0 ? -change : 0)) / len;
        rsi.push(100 - (100 / (1 + avgGain / (avgLoss || 1))));
      }
      return rsi;
    }

    // Indicator Toggle (TradingView-Style)
    document.getElementById('indicators').addEventListener('click', e => {
      if (e.target.dataset.ind) {
        document.querySelectorAll('.ind-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        activeIndicator = e.target.dataset.ind;
        draw(); // Redraw with new overlay
      }
    });

    // Symbol Switch
    document.querySelectorAll('[data-symbol]').forEach(b => {
      b.onclick = () => {
        document.querySelectorAll('[data-symbol]').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        currentSymbol = b.dataset.symbol;
        candles = [];
        setTimeout(connectWS, 500); // Debounce
      };
    });

    // Search (Full Assets)
    const searchInput = document.getElementById('symbolSearch');
    const resultsDiv = document.getElementById('symbolResults');
    searchInput.oninput = async () => {
      const q = searchInput.value.toUpperCase().trim();
      if (q.length < 2) { resultsDiv.style.display = 'none'; return; }
      if (!allSymbols.length) {
        try {
          const res = await fetch('https://api.binance.com/api/v3/exchangeInfo');
          allSymbols = (await res.json()).symbols.filter(s => s.status === 'TRADING').map(s => s.symbol);
        } catch (e) { console.error(e); }
      }
      const matches = allSymbols.filter(s => s.includes(q)).slice(0, 10);
      resultsDiv.innerHTML = matches.map(s => `<div class="result-item" onclick="selectSymbol('${s}')">${s}</div>`).join('');
      resultsDiv.style.display = matches.length ? 'block' : 'none';
    };

    function selectSymbol(sym) {
      currentSymbol = sym;
      candles = [];
      document.querySelectorAll('[data-symbol]').forEach(x => x.classList.remove('active'));
      const btn = document.createElement('button'); btn.className = 'btn active'; btn.textContent = sym.replace('USDT',''); btn.dataset.symbol = sym;
      document.querySelector('.controls').appendChild(btn);
      btn.onclick = () => { currentSymbol = sym; candles = []; setTimeout(connectWS, 500); };
      searchInput.value = ''; resultsDiv.style.display = 'none';
      setTimeout(connectWS, 500);
    }

    // Hide results on click outside
    document.addEventListener('click', e => {
      if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) resultsDiv.style.display = 'none';
    });

    // INIT
    resize();
    connectWS();
  </script>
</body>
</html>
