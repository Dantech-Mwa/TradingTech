<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DJG ELITE TVIEW v5.1 â€¢ TradingView Pro Clone</title>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root[data-theme="dark"] {
      --bg: #131722; --card: #1e222d; --text: #d1d4dc; --green: #26a69a; --red: #ef5350;
      --accent: #2962ff; --gold: #ffd600; --purple: #9c27b0; --orange: #ff9800; --grid: rgba(255,255,255,0.06);
      --border: #2a2e39; --shadow: 0 4px 20px rgba(0,0,0,0.3); --glass: rgba(255,255,255,0.03);
      --hover: #2a2e39; --sidebar: #191b23; --input-bg: #2a2e39;
    }
    :root[data-theme="light"] {
      --bg: #ffffff; --card: #f8f9fa; --text: #131722; --green: #26a69a; --red: #ef5350;
      --accent: #2962ff; --gold: #ffb800; --purple: #7e57c2; --orange: #fb8c00; --grid: rgba(0,0,0,0.06);
      --border: #e0e3eb; --shadow: 0 4px 20px rgba(0,0,0,0.08); --glass: rgba(0,0,0,0.03);
      --hover: #f0f3fa; --sidebar: #f8f9fa; --input-bg: #ffffff;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; overflow:hidden; height:100vh; }
    .container { display:flex; flex-direction:column; height:100vh; }

    /* HEADER */
    .header {
      display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--card); border-bottom:1px solid var(--border); z-index:100; flex-shrink:0;
      box-shadow: var(--shadow);
    }
    .logo { font-weight:900; font-size:1.4rem; background:linear-gradient(90deg,#26a69a,#2962ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .symbol-info { display:flex; align-items:center; gap:16px; margin-left:20px; }
    .current-price { font-size:1.6rem; font-weight:700; color:var(--accent); }
    .price-change { font-size:0.9rem; padding:4px 8px; border-radius:6px; }
    .price-change.pos { background:rgba(38,166,154,0.2); color:var(--green); }
    .price-change.neg { background:rgba(239,83,80,0.2); color:var(--red); }
    .symbol-search {
      flex:1; max-width:300px; margin:0 16px; position:relative;
    }
    .symbol-search input {
      width:100%; padding:8px 12px 8px 36px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); color:var(--text); font-size:0.9rem;
    }
    .symbol-search i { position:absolute; left:12px; top:9px; color:#787b86; }
    .header-actions { display:flex; gap:8px; align-items:center; }
    .btn-icon { padding:8px; border-radius:6px; background:transparent; color:var(--text); cursor:pointer; transition:all 0.2s; }
    .btn-icon:hover { background:var(--hover); }
    .theme-toggle { padding:6px 12px; background:var(--accent); color:#fff; border:none; border-radius:6px; font-weight:600; cursor:pointer; }

    /* MAIN LAYOUT */
    .main-layout { display:flex; flex:1; overflow:hidden; position:relative; }

    /* LEFT SIDEBAR */
    .sidebar-left {
      width:240px; background:var(--sidebar); border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:10;
    }
    .watchlist-header {
      padding:12px; font-weight:600; font-size:0.9rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;
    }
    .watchlist-search { padding:8px; }
    .watchlist-search input { width:100%; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--input-bg); color:var(--text); font-size:0.85rem; }
    .watchlist { flex:1; overflow-y:auto; }
    .watchlist-item {
      padding:8px 12px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; font-size:0.85rem; transition:0.2s;
      border-bottom:1px solid var(--border);
    }
    .watchlist-item:hover { background:var(--hover); }
    .watchlist-item.active { background:var(--accent); color:#fff; }
    .symbol-name { font-weight:600; }
    .price { font-weight:500; }
    .change { font-size:0.8rem; padding:2px 6px; border-radius:4px; }
    .change.pos { background:rgba(38,166,154,0.2); color:var(--green); }
    .change.neg { background:rgba(239,83,80,0.2); color:var(--red); }

    /* RIGHT SIDEBAR */
    .sidebar-right {
      width:300px; background:var(--sidebar); border-left:1px solid var(--border); display:flex; flex-direction:column;
    }
    .tab-header {
      display:flex; border-bottom:1px solid var(--border);
    }
    .tab-btn {
      flex:1; padding:10px; text-align:center; font-size:0.85rem; font-weight:600; cursor:pointer; transition:0.2s;
    }
    .tab-btn.active { border-bottom:2px solid var(--accent); color:var(--accent); }
    .tab-content { flex:1; overflow-y:auto; padding:12px; display:none; }
    .tab-content.active { display:block; }
    .news-item, .idea-item { margin-bottom:16px; font-size:0.85rem; padding:12px; background:var(--glass); border-radius:8px; }
    .news-title, .idea-title { font-weight:600; margin-bottom:4px; }
    .news-time, .idea-time { font-size:0.75rem; color:#787b86; }
    .alert-item { padding:8px; background:var(--glass); border-radius:6px; margin-bottom:8px; font-size:0.8rem; display:flex; justify-content:space-between; align-items:center; }

    /* CHART AREA */
    .chart-area { flex:1; display:flex; flex-direction:column; background:var(--card); position:relative; }
    .top-toolbar {
      display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--card); border-bottom:1px solid var(--border); flex-wrap:wrap;
    }
    .toolbar-group { display:flex; gap:4px; align-items:center; }
    .btn { padding:6px 10px; border-radius:6px; background:var(--glass); border:1px solid var(--border); color:var(--text); cursor:pointer; font-size:0.8rem; font-weight:500; transition:0.2s; }
    .btn:hover { background:var(--hover); }
    .btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .dropdown-btn { padding:6px 10px; background:var(--glass); border:1px solid var(--border); border-radius:6px; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:4px; }
    .dropdown-content { display:none; position:absolute; background:var(--card); min-width:180px; box-shadow:var(--shadow); border:1px solid var(--border); border-radius:8px; z-index:1000; max-height:300px; overflow-y:auto; top:100%; left:0; }
    .dropdown-content.show { display:block; }
    .dropdown-item { padding:8px 12px; cursor:pointer; font-size:0.85rem; transition:0.2s; }
    .dropdown-item:hover { background:var(--hover); }

    .chart-container { flex:1; display:flex; flex-direction:column; position:relative; overflow:hidden; }
    .pane { position:relative; border-bottom:1px solid var(--border); flex-shrink:0; }
    .pane-main { flex:1; min-height:400px; }
    .pane-volume { height:120px; min-height:100px; }
    .pane-seasonal { height:120px; min-height:100px; display:none; }

    /* TICKER */
    .ticker-bar {
      height:36px; background:var(--card); border-top:1px solid var(--border); overflow:hidden; white-space:nowrap;
    }
    .ticker-content {
      display:inline-block; animation: scroll 60s linear infinite; font-size:0.8rem;
    }
    @keyframes scroll { 0% { transform:translateX(100%); } 100% { transform:translateX(-100%); } }
    .ticker-item { display:inline-flex; align-items:center; gap:12px; padding:0 20px; border-right:1px solid var(--border); }
    .ticker-symbol { font-weight:700; color:var(--accent); }
    .ticker-price { min-width:80px; }
    .ticker-change { font-weight:600; padding:2px 6px; border-radius:4px; font-size:0.75rem; }
    .positive { background:var(--green); color:#000; }
    .negative { background:var(--red); color:#fff; }
    .price-up { color:var(--green); }
    .price-down { color:var(--red); }

    /* FOOTER */
    .footer {
      padding:8px 12px; font-size:0.75rem; text-align:center; color:#787b86; background:var(--card); border-top:1px solid var(--border);
    }

    /* MODALS */
    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;
    }
    .modal-content {
      background:var(--card); padding:20px; border-radius:12px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; box-shadow:var(--shadow);
    }

    /* DRAWING */
    .drawing-tools { display:flex; gap:4px; }
    .drawing-btn { padding:6px; border-radius:6px; background:var(--glass); border:1px solid var(--border); cursor:pointer; font-size:0.9rem; }
    .drawing-btn.active { background:var(--accent); color:#fff; }

    /* RESPONSIVE */
    @media(max-width:1024px) { .sidebar-left, .sidebar-right { display:none; } }
    @media(max-width:768px) { .top-toolbar { flex-direction:column; } .toolbar-group { margin-bottom:8px; } }
  </style>
</head>
<body>

  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <div class="logo">DJG ELITE TVIEW v5.1</div>
      <div class="symbol-info">
        <div class="current-price" id="currentPrice">BTC/USDT $0.00</div>
        <div class="price-change" id="priceChange">0.00%</div>
      </div>
      <div class="symbol-search">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Search 2300+ symbols..." id="symbolSearch">
      </div>
      <div class="header-actions">
        <button class="btn-icon" title="Alerts" id="alertsBtn"><i class="fas fa-bell"></i></button>
        <button class="btn-icon" title="Replay" id="replayBtn"><i class="fas fa-play-circle"></i></button>
        <button class="btn-icon" title="Save" id="saveBtn"><i class="fas fa-save"></i></button>
        <button class="btn-icon" title="Export" id="exportBtn"><i class="fas fa-download"></i></button>
        <button class="theme-toggle" id="themeToggle">Light</button>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="main-layout">
      <!-- LEFT SIDEBAR -->
      <div class="sidebar-left">
        <div class="watchlist-header">
          <span>Watchlist</span>
          <i class="fas fa-plus" id="addWatchlist" title="Add Symbol"></i>
        </div>
        <div class="watchlist-search">
          <input type="text" placeholder="Search watchlist or add new..." id="watchlistSearch">
        </div>
        <div class="watchlist" id="watchlist"></div>
      </div>

      <!-- CHART AREA -->
      <div class="chart-area">
        <!-- TOP TOOLBAR -->
        <div class="top-toolbar">
          <div class="toolbar-group">
            <div class="dropdown">
              <button class="dropdown-btn" id="chartTypeBtn"><span id="currentChartType">Candles</span> <i class="fas fa-caret-down"></i></button>
              <div class="dropdown-content" id="chartTypeMenu">
                <div class="dropdown-item" data-type="candlestick">Candlesticks</div>
                <div class="dropdown-item" data-type="line">Line</div>
                <div class="dropdown-item" data-type="area">Area</div>
                <div class="dropdown-item" data-type="bars">Bars</div>
              </div>
            </div>
            <div class="dropdown">
              <button class="dropdown-btn" id="timeframeBtn"><span id="currentTF">1m</span> <i class="fas fa-caret-down"></i></button>
              <div class="dropdown-content" id="timeframeMenu">
                <div class="dropdown-item active" data-tf="1m">1m</div>
                <div class="dropdown-item" data-tf="5m">5m</div>
                <div class="dropdown-item" data-tf="15m">15m</div>
                <div class="dropdown-item" data-tf="1h">1h</div>
                <div class="dropdown-item" data-tf="4h">4h</div>
                <div class="dropdown-item" data-tf="1d">1D</div>
              </div>
            </div>
          </div>

          <div class="toolbar-group">
            <button class="btn" id="indicatorsBtn">Indicators</button>
            <button class="btn" id="alertBtn">Alert</button>
            <button class="btn" id="seasonalBtn">Seasonal</button>
          </div>

          <div class="toolbar-group drawing-tools">
            <button class="drawing-btn" data-tool="trend" title="Trend Line"><i class="fas fa-chart-line"></i></button>
            <button class="drawing-btn" data-tool="fib" title="Fibonacci"><i class="fas fa-wave-square"></i></button>
            <button class="drawing-btn" data-tool="text" title="Text"><i class="fas fa-font"></i></button>
            <button class="drawing-btn" data-tool="erase" title="Erase"><i class="fas fa-eraser"></i></button>
          </div>

          <div class="toolbar-group">
            <button class="btn" id="replayModeBtn">Replay</button>
            <button class="btn" id="settingsBtn"><i class="fas fa-cog"></i></button>
            <button class="btn" id="fullscreenBtn"><i class="fas fa-expand"></i></button>
          </div>
        </div>

        <!-- CHART CONTAINER -->
        <div class="chart-container">
          <div class="pane pane-main" id="mainChart"></div>
          <div class="pane pane-volume" id="volumeChart"></div>
          <div class="pane pane-seasonal" id="seasonalChart"></div>
        </div>
      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="sidebar-right">
        <div class="tab-header">
          <div class="tab-btn active" data-tab="news">News</div>
          <div class="tab-btn" data-tab="ideas">Ideas</div>
          <div class="tab-btn" data-tab="alerts">Alerts</div>
        </div>
        <div class="tab-content active" id="newsTab">
          <div class="news-item"><div class="news-title">Bitcoin ETF Inflows Hit $1B</div><div class="news-time">2h ago</div></div>
          <div class="news-item"><div class="news-title">ETH Upgrade Delayed</div><div class="news-time">5h ago</div></div>
        </div>
        <div class="tab-content" id="ideasTab">
          <div class="idea-item"><div class="idea-title">BTC Long Setup</div><div class="idea-time">by TraderX â€¢ 1h ago</div><p>Bullish on BTC breaking $70K.</p></div>
          <div class="idea-item"><div class="idea-title">ETH Short</div><div class="idea-time">by AnalystY â€¢ 3h ago</div><p>Wait for dip below $3K.</p></div>
        </div>
        <div class="tab-content" id="alertsTab">
          <div id="alertList"></div>
          <button class="btn" style="width:100%; margin-top:8px;" id="createAlert">+ Create Alert</button>
        </div>
      </div>
    </div>

    <!-- TICKER BAR -->
    <div class="ticker-bar">
      <div class="ticker-content" id="tickerContent"></div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      DJG ELITE TVIEW v5.1 â€¢ Professional Trading Platform â€¢ Secure â€¢ Web3 Ready â€¢ Powered by Binance API
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal" id="indicatorModal">
    <div class="modal-content">
      <h3>Indicators</h3>
      <input type="text" placeholder="Search..." id="indicatorSearch" style="width:100%; margin-bottom:12px; padding:8px; border-radius:6px; border:1px solid var(--border);">
      <div id="indicatorList">
        <div class="dropdown-item" data-indicator="sma">SMA (20)</div>
        <div class="dropdown-item" data-indicator="ema">EMA (20)</div>
        <div class="dropdown-item" data-indicator="rsi">RSI (14)</div>
        <div class="dropdown-item" data-indicator="macd">MACD</div>
        <div class="dropdown-item" data-indicator="bollinger">Bollinger Bands</div>
      </div>
    </div>
  </div>

  <div class="modal" id="alertModal">
    <div class="modal-content">
      <h3>Create Alert</h3>
      <select id="alertCondition" style="width:100%; padding:8px; margin:8px 0; border-radius:6px;">
        <option>Price > </option>
        <option>Price < </option>
        <option>RSI > 70</option>
        <option>RSI < 30</option>
      </select>
      <input type="number" id="alertValue" placeholder="Value" style="width:100%; padding:8px; margin:8px 0; border-radius:6px;">
      <button class="btn" style="width:100%;" id="saveAlert">Save Alert</button>
    </div>
  </div>

  <script>
    // =============================================
    // DJG ELITE TVIEW v5.1 â€“ FULLY FIXED & FUNCTIONAL
    // =============================================
    let mainChart, volumeChart, seasonalChart;
    let mainSeries, volumeSeries, seasonalSeries;
    let currentSymbol = 'BTCUSDT', currentTF = '1m', currentChartType = 'candlestick';
    let historicalData = [], isReplay = false, replayIndex = 0, replayInterval;
    let klineWs = null, tickerWs = null;
    let indicators = new Map();
    let allSymbols = [], topSymbols = ['BTCUSDT','ETHUSDT','BNBUSDT','ADAUSDT','SOLUSDT','XRPUSDT','DOTUSDT','DOGEUSDT'];
    let assetData = topSymbols.map(s => ({ symbol: s, price: 0, change: 0, prevPrice: 0, formattedPrice: '$0.00' }));
    let watchlist = [...topSymbols];
    let alerts = [];
    let reconnectDelay = 1000;
    let manualClose = false;
    let currentPrice = 0, currentChange = 0;

    // ========== SYMBOLS & WATCHLIST ==========
    async function loadAllSymbols() {
      try {
        const response = await fetch('https://api.binance.com/api/v3/exchangeInfo');
        const data = await response.json();
        allSymbols = data.symbols
          .filter(s => s.status === 'TRADING' && s.symbol.endsWith('USDT'))
          .map(s => s.symbol)
          .slice(0, 2300);
        console.log(`Loaded ${allSymbols.length} symbols`);
        populateWatchlist();
        updateInitialPrices(); // Fetch initial prices for ticker/watchlist
      } catch (error) {
        console.error('Failed to load symbols:', error);
        allSymbols = [...topSymbols];
        populateWatchlist();
      }
    }

    function populateWatchlist(filtered = watchlist) {
      const list = document.getElementById('watchlist');
      list.innerHTML = '';
      filtered.forEach(sym => {
        const item = document.createElement('div');
        item.className = `watchlist-item ${sym === currentSymbol ? 'active' : ''}`;
        item.dataset.symbol = sym;
        const a = assetData.find(x => x.symbol === sym);
        item.innerHTML = `
          <div class="symbol-name">${sym.replace('USDT','')}/USDT</div>
          <div class="price" id="wl-price-${sym}">${a ? a.formattedPrice : '$0.00'}</div>
          <div class="change ${a && a.change >= 0 ? 'pos' : 'neg'}" id="wl-change-${sym}">${a ? (a.change >= 0 ? '+' : '') + a.change.toFixed(2) + '%' : '0.00%'}</div>
        `;
        item.onclick = () => switchSymbol(sym);
        list.appendChild(item);
      });
    }

    async function updateInitialPrices() {
      for (let sym of topSymbols) {
        try {
          const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${sym}`);
          const data = await response.json();
          const a = assetData.find(x => x.symbol === sym);
          if (a) {
            a.price = parseFloat(data.price);
            a.formattedPrice = formatPrice(a.price);
            a.prevPrice = a.price;
            a.change = 0;
          }
        } catch (e) { console.error(`Price fetch failed for ${sym}:`, e); }
      }
      updateTickerDisplay();
      updateWatchlistDisplay();
    }

    function formatPrice(price) {
      if (price >= 1000) return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      else if (price >= 1) return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
      else return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 6 });
    }

    function updateWatchlistDisplay() {
      watchlist.forEach(sym => {
        const a = assetData.find(x => x.symbol === sym);
        const priceEl = document.getElementById(`wl-price-${sym}`);
        const changeEl = document.getElementById(`wl-change-${sym}`);
        if (priceEl) priceEl.textContent = a ? a.formattedPrice : '$0.00';
        if (changeEl) {
          changeEl.textContent = a ? (a.change >= 0 ? '+' : '') + a.change.toFixed(2) + '%' : '0.00%';
          changeEl.className = `change ${a && a.change >= 0 ? 'pos' : 'neg'}`;
        }
      });
    }

    // ========== TICKER ==========
    function initializeTicker() {
      const content = document.getElementById('tickerContent');
      content.innerHTML = '';
      topSymbols.forEach(sym => {
        const el = document.createElement('div');
        el.className = 'ticker-item';
        const a = assetData.find(x => x.symbol === sym);
        el.innerHTML = `
          <span class="ticker-symbol">${sym.replace('USDT','')}</span>
          <span class="ticker-price ${a && a.price > a.prevPrice ? 'price-up' : a && a.price < a.prevPrice ? 'price-down' : ''}">${a ? a.formattedPrice : '$0.00'}</span>
          <span class="ticker-change ${a && a.change >= 0 ? 'positive' : 'negative'}">${a ? (a.change >= 0 ? '+' : '') + a.change.toFixed(2) + '%' : '0.00%'}</span>
        `;
        content.appendChild(el);
      });
    }

    function updateTickerDisplay() {
      const items = document.querySelectorAll('.ticker-item');
      topSymbols.forEach((sym, i) => {
        const item = items[i];
        if (!item) return;
        const a = assetData.find(x => x.symbol === sym);
        const priceEl = item.querySelector('.ticker-price');
        const changeEl = item.querySelector('.ticker-change');
        if (priceEl) {
          priceEl.textContent = a ? a.formattedPrice : '$0.00';
          priceEl.className = `ticker-price ${a && a.price > a.prevPrice ? 'price-up' : a && a.price < a.prevPrice ? 'price-down' : ''}`;
        }
        if (changeEl) {
          changeEl.innerHTML = a ? (a.change >= 0 ? '+' : '') + a.change.toFixed(2) + '%' : '0.00%';
          changeEl.className = `ticker-change ${a && a.change >= 0 ? 'positive' : 'negative'}`;
        }
      });
      updateWatchlistDisplay();
    }

    // ========== WEBSOCKETS ==========
    function connectKlineWebSocket(symbol, interval) {
      if (klineWs && klineWs.readyState === WebSocket.OPEN) {
        manualClose = true;
        klineWs.close(1000, 'Switching symbol');
      }
      manualClose = false;
      const stream = `${symbol.toLowerCase()}@kline_${interval}`;
      const wsUrl = `wss://stream.binance.com:9443/ws/${stream}`;
      klineWs = new WebSocket(wsUrl);

      klineWs.onopen = () => {
        console.log('Kline WS opened for:', symbol);
        reconnectDelay = 1000;
      };

      klineWs.onmessage = (e) => {
        try {
          const d = JSON.parse(e.data);
          if (!d.k) return;
          const k = d.k;
          const c = { 
            time: Math.floor(k.t / 1000), 
            open: parseFloat(k.o), 
            high: parseFloat(k.h), 
            low: parseFloat(k.l), 
            close: parseFloat(k.c), 
            volume: parseFloat(k.v) 
          };
          if (k.x) {
            historicalData.push(c);
            if (historicalData.length > 500) historicalData.shift();
            if (!isReplay) {
              updateCharts(c);
            }
            updateHeaderPrice(c.close);
          }
        } catch (err) {
          console.error('Kline WS error:', err);
        }
      };

      klineWs.onerror = (err) => console.error('Kline WS error:', err);
      klineWs.onclose = (event) => {
        console.log('Kline WS closed:', event.code, event.reason);
        if (!manualClose) {
          setTimeout(() => connectKlineWebSocket(symbol, interval), reconnectDelay);
          reconnectDelay = Math.min(reconnectDelay * 1.5, 30000);
        }
      };
    }

    function connectTickerWebSocket() {
      if (tickerWs && tickerWs.readyState === WebSocket.OPEN) {
        tickerWs.close();
      }
      const streams = topSymbols.map(s => `${s.toLowerCase()}@ticker`).join('/');
      const wsUrl = `wss://stream.binance.com:9443/stream?streams=${streams}`;
      tickerWs = new WebSocket(wsUrl);

      tickerWs.onopen = () => {
        console.log('Ticker WS connected for top symbols');
      };

      tickerWs.onmessage = (e) => {
        try {
          const message = JSON.parse(e.data);
          if (message.stream && message.data) {
            const s = message.data.s;
            const p = parseFloat(message.data.c);
            const ch = parseFloat(message.data.P);
            const a = assetData.find(x => x.symbol === s);
            if (a) {
              a.prevPrice = a.price;
              a.price = p;
              a.change = ch;
              a.formattedPrice = formatPrice(p);
              updateTickerDisplay();
              if (s === currentSymbol) {
                updateHeaderPrice(p, ch);
              }
            }
          }
        } catch (err) {
          console.error('Ticker WS error:', err);
        }
      };

      tickerWs.onclose = () => setTimeout(connectTickerWebSocket, 5000);
      tickerWs.onerror = (err) => console.error('Ticker WS error:', err);
    }

    function updateHeaderPrice(price, change = currentChange) {
      currentPrice = price;
      currentChange = change;
      const format = formatPrice(price).replace('$', '');
      document.getElementById('currentPrice').innerHTML = `${currentSymbol.replace('USDT','')}/USDT <span style="font-size:1.2rem;">${format}</span>`;
      const changeEl = document.getElementById('priceChange');
      changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
      changeEl.className = `price-change ${change >= 0 ? 'pos' : 'neg'}`;
    }

    // ========== HISTORICAL DATA ==========
    async function fetchHistoricalData(symbol, interval, limit = 500) {
      try {
        const endTime = Date.now();
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}&endTime=${endTime}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        historicalData = data.map(k => ({ 
          time: Math.floor(k[0] / 1000), 
          open: parseFloat(k[1]), 
          high: parseFloat(k[2]), 
          low: parseFloat(k[3]), 
          close: parseFloat(k[4]), 
          volume: parseFloat(k[5]) 
        }));
        console.log(`Loaded ${historicalData.length} candles for ${symbol} ${interval}`);
        recreateAllSeries();
        if (historicalData.length > 0) {
          updateHeaderPrice(historicalData[historicalData.length - 1].close);
        }
        return true;
      } catch (error) {
        console.error('Failed to load historical data:', error);
        return false;
      }
    }

    // ========== CHARTS ==========
    function initializeCharts() {
      const mainEl = document.getElementById('mainChart');
      const volEl = document.getElementById('volumeChart');
      const seasonalEl = document.getElementById('seasonalChart');

      const dark = document.documentElement.dataset.theme === 'dark';
      const options = {
        layout: { 
          background: { color: 'transparent' }, 
          textColor: dark ? '#d1d4dc' : '#131722' 
        },
        grid: { 
          vertLines: { color: 'var(--grid)', visible: true }, 
          horzLines: { color: 'var(--grid)', visible: true } 
        },
        timeScale: { timeVisible: true, secondsVisible: false },
        rightPriceScale: { borderColor: 'var(--border)' },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
      };

      mainChart = LightweightCharts.createChart(mainEl, options);
      volumeChart = LightweightCharts.createChart(volEl, { 
        ...options, 
        grid: { visible: false },
        timeScale: { visible: false },
        rightPriceScale: { visible: false }
      });
      seasonalChart = LightweightCharts.createChart(seasonalEl, options);

      const resizeObserver = new ResizeObserver(() => {
        mainChart.resize(mainEl.offsetWidth, mainEl.offsetHeight);
        volumeChart.resize(volEl.offsetWidth, volEl.offsetHeight);
        seasonalChart.resize(seasonalEl.offsetWidth, seasonalEl.offsetHeight);
      });
      resizeObserver.observe(mainEl);
      resizeObserver.observe(volEl);
      resizeObserver.observe(seasonalEl);
    }

    function recreateAllSeries() {
      if (!historicalData.length) return;

      // Remove old series
      if (mainSeries) mainChart.removeSeries(mainSeries);
      if (volumeSeries) volumeChart.removeSeries(volumeSeries);
      if (seasonalSeries) seasonalChart.removeSeries(seasonalSeries);
      indicators.forEach(ind => ind.remove());

      // Main series (default candlestick)
      mainSeries = mainChart.addCandlestickSeries({
        upColor: '#00ff88',
        downColor: '#ff3b5c',
        borderUpColor: '#00ff88',
        borderDownColor: '#ff3b5c',
        wickUpColor: '#00ff88',
        wickDownColor: '#ff3b5c'
      });
      mainSeries.setData(historicalData);

      // Volume series
      volumeSeries = volumeChart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: { type: 'volume' }
      });
      volumeSeries.setData(historicalData.map(c => ({
        time: c.time,
        value: c.volume,
        color: c.close >= c.open ? 'rgba(0,255,136,0.8)' : 'rgba(255,59,92,0.8)'
      })));

      // Scroll to end
      mainChart.timeScale().scrollToRealTime();

      // Recalculate indicators if any
      indicators.forEach(ind => {
        ind.data = [...historicalData];
        ind.recalculate();
      });
    }

    function updateCharts(candle) {
      if (!mainSeries || !volumeSeries) return;
      mainSeries.update(candle);
      volumeSeries.update({
        time: candle.time,
        value: candle.volume,
        color: candle.close >= candle.open ? 'rgba(0,255,136,0.8)' : 'rgba(255,59,92,0.8)'
      });
      indicators.forEach(ind => ind.update(candle));
    }

    // ========== INDICATORS ==========
    class Indicator {
      constructor(name, chart) {
        this.name = name;
        this.chart = chart;
        this.series = new Map();
        this.data = [];
      }
      update(c) {
        this.data.push(c);
        if (this.data.length > 500) this.data.shift();
        this.recalculate();
      }
      recalculate() {}
      remove() {
        this.series.forEach(s => {
          try { this.chart.removeSeries(s); } catch(e) {}
        });
        this.series.clear();
      }
    }

    // Simple SMA example (add more as needed)
    class SMA extends Indicator {
      constructor(chart) {
        super('sma', chart);
        this.series.set('line', chart.addLineSeries({ color: '#ffd700', lineWidth: 2, title: 'SMA 20' }));
      }
      recalculate() {
        if (this.data.length < 20) return;
        const closes = this.data.map(d => d.close);
        const smaValues = [];
        for (let i = 19; i < closes.length; i++) {
          const slice = closes.slice(i - 19, i + 1);
          smaValues.push(slice.reduce((a, b) => a + b, 0) / 20);
        }
        const seriesData = this.data.slice(19).map((d, i) => ({ time: d.time, value: smaValues[i] }));
        this.series.get('line').setData(seriesData);
      }
    }

    function addIndicator(name) {
      if (indicators.has(name)) {
        const ind = indicators.get(name);
        ind.remove();
        indicators.delete(name);
        return;
      }
      let ind;
      if (name === 'sma') ind = new SMA(mainChart);
      // Add EMA, RSI, etc., similarly
      if (ind) {
        indicators.set(name, ind);
        ind.data = [...historicalData];
        ind.recalculate();
      }
      document.getElementById('indicatorModal').style.display = 'none';
    }

    // ========== ALERTS & IDEAS ==========
    function initializeAlerts() {
      document.getElementById('createAlert').onclick = () => {
        document.getElementById('alertModal').style.display = 'flex';
      };
      document.getElementById('saveAlert').onclick = () => {
        const cond = document.getElementById('alertCondition').value;
        const val = document.getElementById('alertValue').value;
        if (val) {
          alerts.push({ condition: cond, value: parseFloat(val), active: true });
          const list = document.getElementById('alertList');
          const div = document.createElement('div');
          div.className = 'alert-item';
          div.innerHTML = `${cond} ${val} <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--red);cursor:pointer;">Ã—</button>`;
          list.appendChild(div);
          // Simulate check
          if ((cond.includes('>') && currentPrice > parseFloat(val)) || (cond.includes('<') && currentPrice < parseFloat(val))) {
            alert(`Alert Triggered: ${cond} ${val}! Current: $${currentPrice}`);
          }
        }
        document.getElementById('alertModal').style.display = 'none';
        document.getElementById('alertValue').value = '';
      };
    }

    function initializeIdeas() {
      // Static for now; can fetch from API later
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`${btn.dataset.tab}Tab`).classList.add('active');
        };
      });
    }

    // ========== REPLAY MODE ==========
    function toggleReplay() {
      if (isReplay) {
        endReplay();
      } else {
        startReplay();
      }
    }

    function startReplay() {
      if (historicalData.length < 50) {
        alert('Need more data for replay');
        return;
      }
      isReplay = true;
      replayIndex = 0;
      if (klineWs) {
        manualClose = true;
        klineWs.close();
      }
      document.getElementById('replayBtn').innerHTML = '<i class="fas fa-pause"></i> Pause';
      replayInterval = setInterval(() => {
        if (replayIndex >= historicalData.length) {
          endReplay();
          return;
        }
        const candle = historicalData[replayIndex++];
        updateCharts(candle);
        updateHeaderPrice(candle.close);
        mainChart.timeScale().scrollToPosition(100 - (replayIndex / historicalData.length) * 100, false);
      }, 100);
    }

    function endReplay() {
      isReplay = false;
      clearInterval(replayInterval);
      document.getElementById('replayBtn').innerHTML = '<i class="fas fa-play-circle"></i> Replay';
      if (historicalData.length > 0) {
        connectKlineWebSocket(currentSymbol, currentTF);
      }
    }

    // ========== SEASONAL CHART ==========
    function showSeasonal() {
      document.getElementById('seasonalChart').style.display = 'block';
      document.getElementById('volumeChart').style.display = 'none'; // Hide volume temporarily
      if (seasonalSeries) seasonalChart.removeSeries(seasonalSeries);
      seasonalSeries = seasonalChart.addLineSeries({ color: '#ffd700', lineWidth: 2, title: 'Monthly Avg Return' });
      const monthlyReturns = Array(12).fill(0);
      historicalData.forEach(c => {
        const month = new Date(c.time * 1000).getMonth();
        monthlyReturns[month] += ((c.close - c.open) / c.open) * 100;
      });
      const countPerMonth = Array(12).fill(0);
      historicalData.forEach(c => countPerMonth[new Date(c.time * 1000).getMonth()]++);
      const avgReturns = monthlyReturns.map((ret, i) => countPerMonth[i] > 0 ? ret / countPerMonth[i] : 0);
      const seasonalData = avgReturns.map((ret, i) => ({
        time: i + 1, // Month 1-12
        value: ret
      }));
      seasonalSeries.setData(seasonalData);
      seasonalChart.timeScale().fitContent();
    }

    // ========== DRAWING TOOLS (Basic Implementation) ==========
    function initializeDrawing() {
      let isDrawing = false;
      let currentTool = null;
      document.querySelectorAll('.drawing-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.drawing-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentTool = btn.dataset.tool;
          isDrawing = true;
          // Basic canvas overlay for drawing (expand for full tools)
          const canvas = document.createElement('canvas');
          canvas.style.position = 'absolute';
          canvas.style.top = '0';
          canvas.style.left = '0';
          canvas.width = mainChart.container.clientWidth;
          canvas.height = mainChart.container.clientHeight;
          canvas.style.pointerEvents = 'none';
          mainChart.container.appendChild(canvas);
          // Simulate drawing (e.g., trend line on mousedown/mousemove)
          mainChart.container.onmousedown = (e) => { /* Draw logic here */ };
        };
      });
      // Erase tool
      const eraseBtn = document.querySelector('[data-tool="erase"]');
      eraseBtn.onclick = () => {
        mainChart.container.querySelector('canvas')?.remove();
        isDrawing = false;
        currentTool = null;
      };
    }

    // ========== SWITCH SYMBOL ==========
    function switchSymbol(symbol) {
      if (currentSymbol === symbol) return;
      currentSymbol = symbol;
      document.getElementById('currentPrice').innerHTML = `${symbol.replace('USDT','')}/USDT $0.00`; // Temp
      document.querySelectorAll('.watchlist-item').forEach(item => {
        item.classList.toggle('active', item.dataset.symbol === symbol);
      });
      fetchHistoricalData(symbol, currentTF).then(loaded => {
        if (loaded) {
          connectKlineWebSocket(symbol, currentTF);
        }
      });
    }

    // ========== UI EVENT HANDLERS ==========
    function initializeUI() {
      // Dropdowns
      document.querySelectorAll('.dropdown-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const content = btn.parentElement.querySelector('.dropdown-content');
          content.classList.toggle('show');
        };
      });
      document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-content').forEach(c => c.classList.remove('show'));
      });

      // Chart Type
      document.querySelectorAll('#chartTypeMenu .dropdown-item').forEach(item => {
        item.onclick = (e) => {
          e.stopPropagation();
          currentChartType = item.dataset.type;
          document.getElementById('currentChartType').textContent = item.textContent;
          // Recreate series for type change
          recreateAllSeries();
          document.getElementById('chartTypeMenu').classList.remove('show');
        };
      });

      // Timeframe
      document.querySelectorAll('#timeframeMenu .dropdown-item').forEach(item => {
        item.onclick = (e) => {
          e.stopPropagation();
          currentTF = item.dataset.tf;
          document.getElementById('currentTF').textContent = currentTF;
          document.querySelectorAll('#timeframeMenu .dropdown-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          fetchHistoricalData(currentSymbol, currentTF).then(() => connectKlineWebSocket(currentSymbol, currentTF));
          document.getElementById('timeframeMenu').classList.remove('show');
        };
      });

      // Indicators Modal
      document.getElementById('indicatorsBtn').onclick = () => {
        document.getElementById('indicatorModal').style.display = 'flex';
      };
      document.getElementById('indicatorSearch').oninput = (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#indicatorList .dropdown-item').forEach(item => {
          item.style.display = item.textContent.toLowerCase().includes(term) ? 'block' : 'none';
        });
      };
      document.querySelectorAll('#indicatorList .dropdown-item').forEach(item => {
        item.onclick = (e) => {
          e.stopPropagation();
          addIndicator(item.dataset.indicator);
        };
      });

      // Alert Modal Close
      document.querySelectorAll('.modal').forEach(modal => {
        modal.onclick = (e) => {
          if (e.target === modal) modal.style.display = 'none';
        };
      });

      // Toolbar Buttons
      document.getElementById('replayModeBtn').onclick = toggleReplay;
      document.getElementById('seasonalBtn').onclick = showSeasonal;
      document.getElementById('fullscreenBtn').onclick = () => {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          document.documentElement.requestFullscreen();
        }
      };
      document.getElementById('saveBtn').onclick = () => {
        const link = document.createElement('a');
        link.download = 'chart.png';
        link.href = mainChart.takeScreenshot();
        link.click();
      };
      document.getElementById('exportBtn').onclick = () => {
        const link = document.createElement('a');
        link.download = `${currentSymbol}_${currentTF}.png`;
        link.href = mainChart.takeScreenshot();
        link.click();
      };
      document.getElementById('alertsBtn').onclick = () => {
        document.querySelector('[data-tab="alerts"]').click();
      };
      document.getElementById('settingsBtn').onclick = () => alert('Settings: Theme toggle in header.');

      // Theme Toggle
      document.getElementById('themeToggle').onclick = () => {
        const html = document.documentElement;
        const newTheme = html.dataset.theme === 'dark' ? 'light' : 'dark';
        html.dataset.theme = newTheme;
        localStorage.setItem('theme', newTheme);
        document.getElementById('themeToggle').textContent = newTheme === 'dark' ? 'Light' : 'Dark';
        // Recreate charts for theme
        setTimeout(recreateAllSeries, 100);
      };

      // Symbol Search & Add to Watchlist
      document.getElementById('symbolSearch').oninput = (e) => {
        const term = e.target.value.toUpperCase();
        if (term.length < 2) {
          populateWatchlist();
          return;
        }
        const filtered = allSymbols.filter(s => s.includes(term) && !watchlist.includes(s)).slice(0, 10);
        populateWatchlist(filtered);
      };
      document.getElementById('addWatchlist').onclick = () => {
        const sym = prompt('Enter symbol (e.g., ETHUSDT):').toUpperCase();
        if (sym && allSymbols.includes(sym) && !watchlist.includes(sym)) {
          watchlist.push(sym);
          assetData.push({ symbol: sym, price: 0, change: 0, prevPrice: 0, formattedPrice: '$0.00' });
          populateWatchlist();
          connectTickerWebSocket(); // Refresh ticker
        }
      };
      document.getElementById('watchlistSearch').oninput = (e) => {
        const term = e.target.value.toUpperCase();
        const filtered = watchlist.filter(s => s.includes(term));
        populateWatchlist(filtered.length ? filtered : watchlist);
      };

      // Drawing (basic)
      initializeDrawing();

      // Alerts & Ideas
      initializeAlerts();
      initializeIdeas();
    }

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DJG ELITE TVIEW v5.1 Initializing...');
      initializeCharts();
      initializeTicker();
      initializeUI();
      loadAllSymbols().then(() => {
        fetchHistoricalData(currentSymbol, currentTF).then(loaded => {
          if (loaded) {
            connectKlineWebSocket(currentSymbol, currentTF);
            connectTickerWebSocket();
          } else {
            // Retry once
            setTimeout(() => fetchHistoricalData(currentSymbol, currentTF), 2000);
          }
        });
      });
    });
  </script>
</body>
</html>
