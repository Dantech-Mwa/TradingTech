<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elite Live Trading</title>
  <style>
    :root[data-theme="dark"] {
      --bg: #0f0f1a; --card: rgba(20,20,40,0.7); --text: #e0e0ff; --green: #00ff88; --red: #ff3b5c;
      --accent: #00d4ff; --grid: rgba(255,255,255,0.1); --border: rgba(255,255,255,0.1);
    }
    :root[data-theme="light"] {
      --bg: #f8f9fa; --card: rgba(255,255,255,0.9); --text: #212529; --green: #28a745; --red: #dc3545;
      --accent: #007bff; --grid: rgba(0,0,0,0.1); --border: rgba(0,0,0,0.1);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; padding:12px; min-height:100vh; }
    .container { max-width:1400px; margin:0 auto; }
    .header { text-align:center; padding:12px; background:var(--card); border-radius:16px; border:1px solid var(--border); }
    h1 { font-size:2rem; font-weight:800; background:linear-gradient(90deg,var(--green),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    #price { font-size:2.5rem; font-weight:900; margin:8px 0; }
    #status { font-size:0.9rem; margin:8px 0; }
    .status.live { color:var(--green); }
    .status.error { color:var(--red); }
    .controls { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin:12px 0; }
    .btn { padding:8px 16px; border:none; border-radius:8px; background:var(--accent); color:#fff; cursor:pointer; font-weight:600; }
    .btn:hover { background:#aa00ff; }
    .btn.active { background:var(--green); }
    .search-container { display:flex; gap:8px; margin:12px 0; }
    #symbolSearch { padding:8px 12px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text); flex:1; max-width:300px; }
    #symbolResults { background:var(--card); border:1px solid var(--border); border-radius:8px; max-height:200px; overflow-y:auto; position:absolute; z-index:100; width:300px; }
    .result-item { padding:8px; cursor:pointer; border-bottom:1px solid var(--border); }
    .result-item:hover { background:var(--accent); color:#fff; }
    canvas { width:100%; height:500px; background:var(--card); border-radius:16px; margin:16px 0; border:1px solid var(--border); }
    .footer { text-align:center; margin:24px 0; font-size:0.8rem; color:#888; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Elite Live Trading</h1>
      <div id="price">$0.00</div>
      <div id="status" class="status">Starting...</div>
      <div class="search-container">
        <input type="text" id="symbolSearch" placeholder="Search 2300+ symbols...">
        <div id="symbolResults"></div>
      </div>
      <div class="controls">
        <button class="btn active" data-symbol="BTCUSDT">BTC</button>
        <button class="btn" data-symbol="ETHUSDT">ETH</button>
        <button class="btn" data-symbol="BNBUSDT">BNB</button>
      </div>
    </div>
    <canvas id="chart"></canvas>
    <div class="footer">100% Independent • Binance Live • Pure Canvas</div>
  </div>

  <script>
    // ──────────────────────────────────────────────────────────────
    // PURE CANVAS + WEBSOCKET FIXED + DEBOUNCE
    // ──────────────────────────────────────────────────────────────
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    let width, height;
    let data = [], currentSymbol = 'BTCUSDT', ws = null;
    let reconnectTimeout;

    // Resize
    function resize() {
      width = canvas.clientWidth; height = canvas.clientHeight;
      canvas.width = width; canvas.height = height;
      draw();
    }
    window.addEventListener('resize', resize);

    // Status & Price
    function setStatus(msg, type = 'info') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = `status ${type}`;
    }
    function updatePrice(p) {
      document.getElementById('price').textContent = `$${parseFloat(p).toFixed(2)}`;
    }

    // Binance WebSocket (FIXED)
    function connectWS() {
      // Clean up old connection
      if (ws) {
        ws.onopen = ws.onmessage = ws.onerror = ws.onclose = null;
        ws.close();
      }
      clearTimeout(reconnectTimeout);

      setStatus('Connecting...', 'info');
      const stream = currentSymbol.toLowerCase() + '@ticker';
      ws = new WebSocket('wss://stream.binance.com:9443/ws/' + stream);

      ws.onopen = () => {
        setStatus('LIVE • Connected', 'live');
        // Immediate price
        fetchPrice();
      };

      ws.onmessage = e => {
        const d = JSON.parse(e.data);
        updatePrice(d.c);
        data.push({ time: Date.now(), price: +d.c });
        if (data.length > 100) data.shift();
        draw();
      };

      ws.onerror = () => {
        setStatus('Connection error', 'error');
      };

      ws.onclose = () => {
        setStatus('Reconnecting in 3s...', 'error');
        reconnectTimeout = setTimeout(connectWS, 3000);
      };
    }

    // Fetch price immediately (fallback)
    function fetchPrice() {
      fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${currentSymbol}`)
        .then(r => r.json())
        .then(d => updatePrice(d.price))
        .catch(() => {});
    }

    // Pure Canvas Chart
    function draw() {
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card').trim();
      ctx.fillRect(0, 0, width, height);
      if (data.length < 2) return;

      const prices = data.map(d => d.price);
      const min = Math.min(...prices), max = Math.max(...prices);
      const range = max - min || 1;
      const padding = 50;

      // Grid
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (height - 2*padding) * (i/5);
        ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(width - padding, y); ctx.stroke();
      }

      // Price Line
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--green').trim();
      ctx.lineWidth = 2;
      ctx.beginPath();
      data.forEach((d, i) => {
        const x = padding + (width - 2*padding) * (i / (data.length - 1));
        const y = height - padding - (height - 2*padding) * ((d.price - min) / range);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Labels
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
      ctx.font = '14px Inter';
      ctx.fillText(`$${max.toFixed(2)}`, width - padding - 80, 25);
      ctx.fillText(`$${min.toFixed(2)}`, width - padding - 80, height - 10);
    }

    // Symbol Switch with DEBOUNCE
    let switchTimeout;
    document.querySelectorAll('[data-symbol]').forEach(b => {
      b.onclick = () => {
        clearTimeout(switchTimeout);
        document.querySelectorAll('[data-symbol]').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        currentSymbol = b.dataset.symbol;
        data = [];
        switchTimeout = setTimeout(() => {
          connectWS();
        }, 300); // Prevent spam
      };
    });

    // Search
    const searchInput = document.getElementById('symbolSearch');
    const resultsDiv = document.getElementById('symbolResults');
    let allSymbols = [];
    searchInput.oninput = async () => {
      const q = searchInput.value.toUpperCase().trim();
      if (q.length < 2) { resultsDiv.style.display = 'none'; return; }
      if (!allSymbols.length) {
        try {
          const res = await fetch('https://api.binance.com/api/v3/exchangeInfo');
          allSymbols = (await res.json()).symbols.filter(s => s.status === 'TRADING').map(s => s.symbol);
        } catch (e) { console.error(e); }
      }
      const matches = allSymbols.filter(s => s.includes(q)).slice(0, 10);
      resultsDiv.innerHTML = matches.map(s => `<div class="result-item" onclick="selectSymbol('${s}')">${s}</div>`).join('');
      resultsDiv.style.display = matches.length ? 'block' : 'none';
    };

    function selectSymbol(sym) {
      currentSymbol = sym;
      data = [];
      document.querySelectorAll('[data-symbol]').forEach(x => x.classList.remove('active'));
      const btn = document.createElement('button');
      btn.className = 'btn active'; btn.textContent = sym.replace('USDT',''); btn.dataset.symbol = sym;
      document.querySelector('.controls').appendChild(btn);
      btn.onclick = () => { currentSymbol = sym; data = []; setTimeout(connectWS, 300); };
      searchInput.value = ''; resultsDiv.style.display = 'none';
      setTimeout(connectWS, 300);
    }

    // INIT
    resize();
    connectWS();
    fetchPrice(); // Immediate price
  </script>
</body>
</html>
